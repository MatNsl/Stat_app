---
title: "Recentered Influence Functions"
output: pdf_document
date: "2024-03-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
install.packages("dplyr")
install.packages("ggplot2")
install.packages("dineq") # specific package for RIF
library("dplyr")
library("ggplot2")
library("labelled")
```

```{r}
source(file = "~/work/Stat_app/DATA/exporting_data_from_link.R")
```

```{r}
eulfs_small$hwusual <- na_if(eulfs_small$hwusual, 99)
```

Source:
https://search.r-project.org/CRAN/refmans/dineq/html/00Index.html

## Recentered influence function of the 1st quartile (25th quantile)

```{r}
rif_q25 <- dineq::rif(x=eulfs_small$hwusual, weights=NULL, method="quantile", quantile=0.25)
```

rif_q25 is a vector with as many components as observations in eulfs_small
Each component corresponds to a particular individualâ€™s influence on the distributional statistic

## Regression with some RIF

```{r}
# RIF Regression with the same distributional statistic, namely the 25th quantile
rifr_q <- dineq::rifr(hwusual ~ sex, eulfs_small, weights = NULL, method = "quantile", quantile = 0.25, kernel = "gaussian")
```

```{r}
rifr_q[["Coef"]]
```

## Visualisation

```{r}
val_coef = c()
for (q in seq(0.05, 0.95, by=0.05)) {
  rifr_q <- dineq::rifr(hwusual ~ age + as.factor(sex) + as.factor(hatlev1d), eulfs_small, weights = NULL, method = "quantile", quantile = q, kernel = "gaussian")
  coefs <- as.vector(rifr_q[["Coef"]])
  val_coef <- c(val_coef, coefs[2])
}
rm(q, rifr_q, coefs)
quant <- as.vector(seq(0.05, 0.95, by=0.05))
df_quant <- data.frame(quant, val_coef)
```

```{r}
# ggplot(df_quant, aes(x = "quant", y = "val_coef")) + 
#   labs(x="Quantile",y="Effect of age", title = "Unconditional quantile regressions estimates \n of the effect of age on the number of hours usually worked") 
# + 
#  geom_line()
```

```{r}
plot(quant, val_coef, type="l", xlab="Quantile", ylab="Effect of age", main = "Unconditional quantile regressions estimates \n of the effect of age on the number of hours usually worked", las = 2)
```

Figure 1. **A majority of workers wish to conform to the norm**. Density of the number of hours usually worked (in red) and density of the number of hours people wish to work (in black), all years combined. 31 countries from the 2014 release of the EU Labor Force Survey, own analyses.

```{r}
### First step: the number of hours people usually work for each age
each_age <- c()
dens_y <- c()
dens_length <- c()
for (hw in seq(20, 60, by=20)) {
  # Specific dataframe
  eulfs_hw <- eulfs_small %>% filter(hw - 5 < hwusual &  hwusual < hw + 5) %>% select(age)
  for (i in eulfs_hw$age){
    each_age <- c(each_age, count(eulfs_hw$age = i))
  }
    
}



### Plot
# Plot y-values scaled by number of observations against x values
# par(mar = c(5.1, 5.1, 4.1, 2.1))
plot <- plot(dens_x[1:dens_length[1]], dens_y[1:dens_length[1]], type="l", xlab="Age", ylab="", main = "Distribution of the number of hours", las = 2)
lines(dens_x[dens_length[1]+1:dens_length[2]], dens_y[dens_length[1]+1:dens_length[2]], col = "red")
# lines(dens_x[dens_length[2]+1:length(dens_x)], dens_y[dens_length[2]+1:length(dens_x)], col = "blue")
title(ylab = "Proportion of people", line = 3) # a readable y-label

# BUG

```

# Need to delete negative values for the number of working hours, as well as the values above 80 hours which are absent to the dataset
# Need for x and y with the same length
n <- length(dens_hw[[1]])
dens_hw[[1]] <- dens_hw[[1]][!(dens_hw[[1]] < 0)]
n_1 <- length(dens_hw[[1]])
loss_1 <- n - n_1 # number of first elements that were deleted
dens_hw[[1]] <- dens_hw[[1]][!(dens_hw[[1]] > 80)]
loss_2 <- n_1 - length(dens_hw[[1]]) # number of last elements that were deleted
dens_hw[[2]] <- tail(dens_hw[[2]],-loss_1)
dens_hw[[2]] <- head(dens_hw[[2]], -loss_2)


```{r}
dens_x <- c()
dens_y <- c()
dens_length <- c()

  # Specific dataframe
  eulfs_hw <- eulfs_small %>% filter(hwusual == 20) %>% select(age)
  # Get the density estimate
  dens_hw <- density(eulfs_hw$age, na.rm = TRUE)
  dens_x <- c(dens_x, dens_hw$x)
  dens_y <- c(dens_y, dens_hw$y)
  dens_length <- c(dens_length, length(dens_hw$x))


plot <- plot(dens_x[dens_length[1]+1:dens_length[2]], dens_y[dens_length[1]+1:dens_length[2]], type="l", xlab="Age", ylab="", main = "Distribution of the number of hours", las = 2)
```


```{r}
eulfs_small_b <- eulfs_small %>% filter(hwusual == 20) %>% select(age)
hist(eulfs_small_b$age)
```

```{r}
eulfs_small_b <- eulfs_small %>% filter(hwusual == 40) %>% select(age)
hist(eulfs_small_b$age)
```

```{r}
eulfs_small_b <- eulfs_small %>% filter(hwusual == 60) %>% select(age)
hist(eulfs_small_b$age)
```

```{r}
### First step: the number of hours people usually work for each age
dens_x <- c()
dens_y <- c()
dens_length <- c()
for (old in seq(22, 62, by=20)) {
  # Specific dataframe
  eulfs_age <- eulfs_small %>% filter(age == old) %>% select(hwusual)
  # Get the density estimate
  dens_old <- density(eulfs_age$hwusual, na.rm = TRUE)
# Need to delete negative values for the number of working hours, as well as the values above 80 hours which are absent to the dataset
# Need for x and y with the same length
n <- length(dens_old[[1]])
dens_old[[1]] <- dens_old[[1]][!(dens_old[[1]] < 0)]
n_1 <- length(dens_old[[1]])
loss_1 <- n - n_1 # number of first elements that were deleted
dens_old[[1]] <- dens_old[[1]][!(dens_old[[1]] > 80)]
loss_2 <- n_1 - length(dens_old[[1]]) # number of last elements that were deleted
dens_old[[2]] <- tail(dens_old[[2]],-loss_1)
dens_old[[2]] <- head(dens_old[[2]], -loss_2)
dens_x <- c(dens_x, dens_old$x)
dens_y <- c(dens_y, dens_old$y)
dens_length <- c(dens_length, length(dens_old$x))
}


### Plot
# Plot y-values scaled by number of observations against x values
# par(mar = c(5.1, 5.1, 4.1, 2.1))
plot <- plot(dens_x[1:dens_length[1]], dens_y[1:dens_length[1]], type="l", xlab="Number of hours", ylab="", main = "Distribution of the number of hours", las = 2)
lines(dens_x[dens_length[1]+1:dens_length[2]], dens_y[dens_length[1]+1:dens_length[2]], col = "red")
lines(dens_x[dens_length[2]+1:length(dens_x)], dens_y[dens_length[2]+1:length(dens_x)], col = "blue")
title(ylab = "Proportion of people", line = 3) # a readable y-label

# BUG

```

```{r}


```

```{r}

```


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
