---
title: "Recentered Influence Functions"
output: pdf_document
date: "2024-03-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
install.packages("dplyr")
install.packages("ggplot2")
install.packages("labelled")
install.packages("dineq") # specific package for RIF

install.packages("stargazer") # for nice tables
```

```{r}
library("dplyr")
library("ggplot2")
library("labelled")
```

```{r}
source(file = "~/work/Stat_app/DATA/exporting_data_from_link.R")
```

```{r}
eulfs_small$hwusual <- na_if(eulfs_small$hwusual, 99)
```

Source:
https://search.r-project.org/CRAN/refmans/dineq/html/00Index.html

## Recentered influence function of the 1st quartile (25th quantile)

```{r}
rif_q25 <- dineq::rif(x=eulfs_small$hwusual, weights=NULL, method="quantile", quantile=0.25)
```

rif_q25 is a vector with as many components as observations in eulfs_small.
Each component corresponds to a particular individualâ€™s influence on the distributional statistic.

## Regression with some RIF

It is possible to make a regression with a specific quantile.
```{r}
# RIF Regression with the same distributional statistic, namely the 25th quantile
rifr_q <- dineq::rifr(hwusual ~ sex, eulfs_small, weights = NULL, method = "quantile", quantile = 0.25, kernel = "gaussian")
```

We may thus obtain the coefficients.
```{r}
rifr_q[["Coef"]]
```

## Visualisation

One may want to regress the number of hours usually worked on age and control variables (sex and education) and take into account numerous quantiles to see the effect of age on the outcome variable.
Obviously, more work has to be done on the control variables.
```{r}
val_coef = c()
for (q in seq(0.05, 0.95, by=0.05)) {
  rifr_q <- dineq::rifr(hwusual ~ age + as.factor(sex) + as.factor(hatlev1d), eulfs_small, weights = NULL, method = "quantile", quantile = q, kernel = "gaussian")
  coefs <- as.vector(rifr_q[["Coef"]])
  val_coef <- c(val_coef, coefs[2])
}
rm(q, rifr_q, coefs)
quant <- as.vector(seq(0.05, 0.95, by=0.05))
df_quant <- data.frame(quant, val_coef)
rm(quant, val_coef)
```

```{r}
plot(df_quant$quant, df_quant$val_coef, type="l", xlab="Quantile", ylab="Effect of age", main = "Unconditional quantile regressions estimates \n of the effect of age on the number of hours usually worked", las = 2)
```

Figure 1. **The effect of age on the number of working hours is negative for those who work a little but positive for those who work a lot**. Coefficients before the age variable in the regression of the number of hours usually worked on age and control variables (sex and education), all years combined. 31 countries from the 2014 release of the EU Labor Force Survey, own analyses.

A nice table.
```{r}
stargazer::stargazer(df_quant, title = "Usual working hours regressed on age, sex, and education", column.labels = c("Number of hours usually worked in main job"))

print.data.frame(df_quant, row.names = FALSE)

```
covariate.labels = c("Sex (1 for male and 2 for female)", "Constant"), model.names = TRUE, keep.stat="n", omit.stat = c("rsq", "adj.rsq","ser","f")

```{r}
install.packages("lemon")
knit_print.data.frame <- lemon::lemon_print
```

```{r caption="Data frame is now printed using `kable`.",render=lemon_print}
df_quant
```






We may wonder if we can find again those results by looking at the age structure for different values of working hours.
```{r}
### First step: get the vectors for the plot
each_age <- c()
age_by_hw <- c() # vector with every ages concerned for each working-hour bracket
age_by_hw_length <- c() # vector with the number of ages concerned for each working-hour bracket
for (hw in seq(20, 60, by=20)) {
  # Specific dataframe
  eulfs_hw <- eulfs_small %>% filter(hw - 5 <= hwusual &  hwusual < hw + 5) %>% select(age)
  # Adding values to 3 vectors that are useful for plotting
  age_by_hw_length <- c(age_by_hw_length, length(as.vector(unique(eulfs_hw$age))))
  age_by_hw <- c(age_by_hw, sort(as.vector(unique(eulfs_hw$age))))
  n_total <- nrow(eulfs_hw[eulfs_hw$age != 0,])
  for (i in unique(eulfs_hw$age)){
    each_age <- c(each_age, nrow(eulfs_hw[eulfs_hw$age == i, ])/n_total)
  }
}

### Plot
# Values to target only parts of vectors to have 3 curves
n1 <- age_by_hw_length[1]
n1b <- n1+1
n2 <- age_by_hw_length[1]+age_by_hw_length[2]
n2b <- n2+1
n3 <- age_by_hw_length[1]+age_by_hw_length[2]+age_by_hw_length[3]
# Plot y-values scaled by number of observations against x values
plot <- plot(age_by_hw[n2b:n3], each_age[n2b:n3], type="l", xlab="Age", ylab="", main = "Age structure for different groups of people \ndepending on their number of working hours", las = 2) # Those who work between 55 and 65 hours
lines(age_by_hw[n1b:n2], each_age[n1b:n2], col = "red") # Those who work between 35 and 45 hours
lines(age_by_hw[1:n1], each_age[1:n1], col = "blue") # Those who work between 15 and 25 hours
title(ylab = "Proportion of people", line = 3) # a readable y-label
rm(n1, n1b, n2, n2b, n3)
```

Figure 2. **Those who work the less have a very different age structure compared with others**. Proportion of people in each age bracket who usually work a certain number of hours (in blue between 15 and 25 hours, in red between 35 and 45 hours, in black between 55 and 65 hours), all years combined. 31 countries from the 2014 release of the EU Labor Force Survey, own analyses.

Figure 2 is consistent with the results of RIF regression. Indeed, those who work the less tend to be younger than others, with only a small proportion aged between 50 and 60 years old. On the contrary, the two other groups have a peak for this age bracket, with the highest peak for those who work the most.

```{r}

plot(each_age[33:47])

```

```{r}
eulfs_small_b <- eulfs_small %>% filter(hwusual == 20) %>% select(age)
n_tot <- nrow(eulfs_small_b)
hist((eulfs_small_b$age)/(n_tot))
# No sense! Rather look at arguments of hist
# cf below
```

```{r}
eulfs_small_b <- eulfs_small %>% filter(hwusual == 40) %>% select(age)
hist(eulfs_small_b$age, freq = FALSE)
```

```{r}
eulfs_small_b <- eulfs_small %>% filter(hwusual == 40) %>% select(age)
hist(eulfs_small_b$age)
```

```{r}
eulfs_small_b <- eulfs_small %>% filter(hwusual == 60) %>% select(age)
hist(eulfs_small_b$age)
```

```{r}
### First step: the number of hours people usually work for each age
dens_x <- c()
dens_y <- c()
dens_length <- c()
for (old in seq(22, 62, by=20)) {
  # Specific dataframe
  eulfs_age <- eulfs_small %>% filter(age == old) %>% select(hwusual)
  # Get the density estimate
  dens_old <- density(eulfs_age$hwusual, na.rm = TRUE)
# Need to delete negative values for the number of working hours, as well as the values above 80 hours which are absent to the dataset
# Need for x and y with the same length
n <- length(dens_old[[1]])
dens_old[[1]] <- dens_old[[1]][!(dens_old[[1]] < 0)]
n_1 <- length(dens_old[[1]])
loss_1 <- n - n_1 # number of first elements that were deleted
dens_old[[1]] <- dens_old[[1]][!(dens_old[[1]] > 80)]
loss_2 <- n_1 - length(dens_old[[1]]) # number of last elements that were deleted
dens_old[[2]] <- tail(dens_old[[2]],-loss_1)
dens_old[[2]] <- head(dens_old[[2]], -loss_2)
dens_x <- c(dens_x, dens_old$x)
dens_y <- c(dens_y, dens_old$y)
dens_length <- c(dens_length, length(dens_old$x))
}


### Plot
# Plot y-values scaled by number of observations against x values
# par(mar = c(5.1, 5.1, 4.1, 2.1))
plot <- plot(dens_x[1:dens_length[1]], dens_y[1:dens_length[1]], type="l", xlab="Number of hours", ylab="", main = "Distribution of the number of hours", las = 2)
lines(dens_x[dens_length[1]+1:dens_length[2]], dens_y[dens_length[1]+1:dens_length[2]], col = "red")
lines(dens_x[dens_length[2]+1:length(dens_x)], dens_y[dens_length[2]+1:length(dens_x)], col = "blue")
title(ylab = "Proportion of people", line = 3) # a readable y-label

# BUG

```

```{r}
eulfs_small_b <- eulfs_small %>% filter(hwusual == 60) %>% select(age)
hist((eulfs_small_b$age)/count())

```

```{r}
### First step: get the vectors for the plot
each_age <- c()
age_by_hw <- c() # vector with every ages concerned for each working-hour bracket
age_by_hw_length <- c() # vector with the number of ages concerned for each working-hour bracket
for (hw in seq(60)) {
  # Specific dataframe
  eulfs_hw <- eulfs_small %>% filter(hw - 5 < hwusual &  hwusual < hw + 5) %>% select(age)
  # Adding values to 3 vectors that are useful for plotting
  age_by_hw_length <- c(age_by_hw_length, length(as.vector(unique(eulfs_hw$age))))
  age_by_hw <- c(age_by_hw, sort(as.vector(unique(eulfs_hw$age))))
  n_total <- nrow(eulfs_hw[eulfs_hw$age,])
  for (i in unique(eulfs_hw$age)){
    each_age <- c(each_age, nrow(eulfs_hw[eulfs_hw$age == i, ]))
  }
}

### Plot
# Values to target only parts of vectors to have 3 curves
n1 <- age_by_hw_length[1]
# n1b <- n1+1
# n2 <- age_by_hw_length[1]+age_by_hw_length[2]
# n2b <- n2+1
# n3 <- age_by_hw_length[1]+age_by_hw_length[2]+age_by_hw_length[3]
# Plot y-values scaled by number of observations against x values
plot <- plot(age_by_hw[1:n1], each_age[1:n1], type="l", xlab="Age", ylab="", main = "Age structure for different groups of people \ndepending on their number of working hours", las = 2) # Those who work between 55 and 65 hours
# lines(age_by_hw[n1b:n2], each_age[n1b:n2], col = "red") # Those who work between 35 and 45 hours
# lines(age_by_hw[1:n1], each_age[1:n1], col = "blue") # Those who work between 15 and 25 hours
title(ylab = "Proportion of people", line = 3) # a readable y-label
# rm(n1, n1b, n2, n2b, n3)
```

Ideas:
graph.freq: Histogram
plot.freq: Plot a frequency table

```{r}

```

```{r}

```


