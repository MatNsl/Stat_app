---
title: "Unconditional Quantile Regressions"
output:
  pdf_document: default
  html_document: default
date: "2024-04-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Preliminaries

```{r}
install.packages("dplyr")
install.packages("ggplot2")
install.packages("labelled")
install.packages("dineq") # specific package for RIF
install.packages("stargazer") # for nice tables
install.packages("sandwich")
install.packages("lmtest")
```

```{r}
library("dplyr")
library("ggplot2")
library("labelled")
```

```{r}
source(file = "~/work/Stat_app/DATA/exporting_data_from_link.R")
```

```{r}
eulfs_small$hwusual <- na_if(eulfs_small$hwusual, 99)
```


## Results from a simple linear regression for comparison

```{r}
reg_lm <- lm(formula = hwusual ~ age + as.factor(sex) + as.factor(hatlev1d), data = eulfs_small)
v_country = sandwich::vcovCL(reg_lm, cluster = ~country)
reg_year = lmtest::coeftest(reg_lm, v_country)
```

```{r}
stargazer::stargazer(reg_lm, title = "Usual working hours regressed on age, sex and education, standard errors account for clustering by countries", column.labels = c("Number of hours usually worked in main job"), covariate.labels = c("Age", "Female", "Low education", "Medium education", "High education", "Constant"), model.names = TRUE, keep.stat="n", omit.stat = c("rsq", "adj.rsq","ser","f"))
```
% Table created by stargazer v.5.2.3 by Marek Hlavac, Social Policy Institute. E-mail: marek.hlavac at gmail.com
% Date and time: Sat, Apr 27, 2024 - 02:31:56 PM
\begin{table}[!htbp] \centering 
  \caption{Usual working hours regressed on age, sex and education, standard errors account for clustering by countries} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{1}{c}{\textit{Dependent variable:}} \\ 
\cline{2-2} 
\\[-1.8ex] & hwusual \\ 
\\[-1.8ex] & \textit{OLS} \\ 
 & Number of hours usually worked in main job \\ 
\hline \\[-1.8ex] 
 Age & 0.006$^{**}$ \\ 
  & (0.003) \\ 
  & \\ 
 Female & $-$5.501$^{***}$ \\ 
  & (0.075) \\ 
  & \\ 
 Low education & 1.658$^{***}$ \\ 
  & (0.093) \\ 
  & \\ 
 Medium education & 2.114$^{***}$ \\ 
  & (0.106) \\ 
  & \\ 
 High education & 38.018$^{***}$ \\ 
  & (0.154) \\ 
  & \\ 
\hline \\[-1.8ex] 
Observations & 107,502 \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{1}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table}

We notice that age is the less significant of all our variables and the one with the smallest effect.


## Results from an Unconditional Quantile Regression

```{r}
# RIF Regression with the median
rifr_med <- dineq::rifr(hwusual ~ age + (sex - 1) + as.factor(hatlev1d), eulfs_small, weights = NULL, method = "quantile", quantile = 0.5, kernel = "gaussian")
```

```{r}
### Function to have a clean table based on a RIF Regression
# Indeed, stargazer does not take into account rif regressions
table_rifr <- function(rifr, Title_tab, vec_names){
  cat(c(
"\\begin{table}[!htbp] \\centering\n", 
  "\\caption{", Title_tab, "}\n", 
  "\\label{}\n", 
"\\begin{tabular}{@{\\extracolsep{5pt}}lc}\n", 
"\\\\[-1.8ex]\\hline\n", 
"\\hline \\\\[-1.8ex]\n", 
" & \\multicolumn{1}{c}{\\textit{Dependent variable:}} \\\\\n", 
"\\cline{2-2}\n", 
"\\\\[-1.8ex] & hwusual \\\\\n", 
"\\\\[-1.8ex] & \\textit{UQR} \\\\\n", 
" & Number of hours usually worked in main job \\\\\n", 
"\\hline \\\\[-1.8ex]\n"
  ))
  for (i in 1:length(rifr[["Coef"]])){
    # First calculate significance (to have *, ** or ***)
    if (rifr[["p"]][i] < 0.01){
      star <- "***"
    } else if (rifr[["p"]][i] < 0.05){
      star <- "**"
    } else if (rifr[["p"]][i] < 0.1){
      star <- "*"
    }
    else{star <- ""}
    # Then Print the line for each variable
    cat(c(
    " ", vec_names[i], " & ", format(round(rifr[["Coef"]][i], 4), nsmall = 4), "$^{", star,"}$ \\\\ 
    & (", format(round(rifr[["SE"]][i], 4), nsmall = 4), ") \\\\ 
    & \\\\
    "
    )
    )
  }
  cat(c(
    "\\hline \\\\[-1.8ex] 
\\textit{Note:}  & \\multicolumn{1}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\\\ 
\\end{tabular} 
\\end{table}"
  ))
}
```

```{r}
### Applying the function previously created to our regression 
table_rifr(rifr_med, "RIF Regression using the median: usual working hours regressed on age, sex and education", c("Age", "Female", "Low education", "Medium education", "High education"))
```

\begin{table}[!htbp] \centering
 \caption{ RIF Regression using the median: usual working hours regressed on age, sex and education }
 \label{}
 \begin{tabular}{@{\extracolsep{5pt}}lc}
 \\[-1.8ex]\hline
 \hline \\[-1.8ex]
  & \multicolumn{1}{c}{\textit{Dependent variable:}} \\
 \cline{2-2}
 \\[-1.8ex] & hwusual \\
 \\[-1.8ex] & \textit{UQR} \\
  & Number of hours usually worked in main job \\
 \hline \\[-1.8ex]
  Age  &  -0.0014 $^{ *** }$ \\ 
    & ( 2e-04 ) \\ 
    & \\
      Female  &  -0.3434 $^{ *** }$ \\ 
    & ( 0.0049 ) \\ 
    & \\
      Low education  &  40.6755 $^{ *** }$ \\ 
    & ( 0.0121 ) \\ 
    & \\
      Medium education  &  40.7754 $^{ *** }$ \\ 
    & ( 0.0112 ) \\ 
    & \\
      High education  &  40.7084 $^{ *** }$ \\ 
    & ( 0.0121 ) \\ 
    & \\
    \hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{1}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\end{table}

Age has still a very small coefficient, but its sign has changed.


## Series of Unconditional Quantile Regressions

One may want to regress the number of hours usually worked on age and control variables (sex and education) and take into account numerous quantiles to see the effect of age on the outcome variable.

```{r}
val_coef = c()
for (q in seq(0.05, 0.95, by=0.05)) {
  rifr_q <- dineq::rifr(hwusual ~ age + (sex - 1) + as.factor(hatlev1d), eulfs_small, weights = NULL, method = "quantile", quantile = q, kernel = "gaussian")
  coefs <- as.vector(rifr_q[["Coef"]])
  val_coef <- c(val_coef, coefs[2])
}
rm(q, rifr_q, coefs)
quant <- as.vector(seq(0.05, 0.95, by=0.05))
df_quant <- data.frame(quant, val_coef)
rm(quant, val_coef)
```

```{r}
plot(df_quant$quant, df_quant$val_coef, type="l", xlab="Quantile", ylab="Effect of age", main = "Unconditional quantile regressions estimates \n of the effect of age on the number of hours usually worked", las = 2)
```
Figure 1. **The effect of age on the number of working hours is strongly negative for those who work a little and negative, but to a lesser extent, for those who work a lot**. Coefficients before the age variable in the regression of the number of hours usually worked on age and control variables (sex and education), all years combined. 31 countries from the 2014 release of the EU Labor Force Survey, own analyses.

We may wonder if changing the quantiles has any impact on the results.
Let's try more precise quantiles.
```{r}
val_coef = c()
for (q in seq(0.01, 0.99, by=0.01)) {
  rifr_q <- dineq::rifr(hwusual ~ age + (sex - 1) + as.factor(hatlev1d), eulfs_small, weights = NULL, method = "quantile", quantile = q, kernel = "gaussian")
  coefs <- as.vector(rifr_q[["Coef"]])
  val_coef <- c(val_coef, coefs[2])
}
rm(q, rifr_q, coefs)
quant <- as.vector(seq(0.01, 0.99, by=0.01))
df_quant <- data.frame(quant, val_coef)
rm(quant, val_coef)
```
We got the message: 
"Warning: essentially perfect fit: summary may be unreliable"

```{r}
plot(df_quant$quant, df_quant$val_coef, type="l", xlab="Quantile", ylab="Effect of age", main = "Unconditional quantile regressions estimates \n of the effect of age on the number of hours usually worked \n (using percentiles)", las = 2)
```
Figure 2. **The effect of age on the number of working hours is negative, with extreme values, for those who work a little and negative, but to a lesser extent, for those who work a lot**. Coefficients before the age variable in the regression of the number of hours usually worked on age and control variables (sex and education), all years combined. 31 countries from the 2014 release of the EU Labor Force Survey, own analyses.
This 2nd figure seems useless since we get over-fitting: indeed, only a few people are concerned for each quantile.
However, it clearly shows that the part of the population who work a little is more heterogeneous, and that it is this part of the population which is the most affected by age.


Let's try a third case.
```{r}
val_coef = c()
for (q in seq(0.1, 0.9, by=0.1)) {
  rifr_q <- dineq::rifr(hwusual ~ age + (sex - 1) + as.factor(hatlev1d), eulfs_small, weights = NULL, method = "quantile", quantile = q, kernel = "gaussian")
  coefs <- as.vector(rifr_q[["Coef"]])
  val_coef <- c(val_coef, coefs[2])
}
rm(q, rifr_q, coefs)
quant <- as.vector(seq(0.1, 0.9, by=0.1))
df_quant <- data.frame(quant, val_coef)
rm(quant, val_coef)
```

```{r}
plot(df_quant$quant, df_quant$val_coef, type="l", xlab="Quantile", ylab="Effect of age", main = "Unconditional quantile regressions estimates \n of the effect of age on the number of hours usually worked \n (using deciles)", las = 2)
```
Figure 3. **The effect of age on the number of working hours is strongly negative for those who work a little and only slightly negative for those who work a lot**. Coefficients before the age variable in the regression of the number of hours usually worked on age and control variables (sex and education), all years combined. 31 countries from the 2014 release of the EU Labor Force Survey, own analyses.
This third case is obviously less precise than the first one but roughly shows the same trends.


## Oaxaca decomposition with RIF

We will try to make a Oaxaca decomposition with two RIF regressions.
Our two groups will be 1998 and 2013.
The reference year for the decomposition is 2013.

```{r}
# Two more precise datasets
eulfs1998 <- eulfs_small[eulfs_small$year == 1998,]
eulfs2013 <- eulfs_small[eulfs_small$year == 2013,]
```

```{r}
# RIF Regressions with the first quartile
rifr_1998 <- dineq::rifr(hwusual ~ age + (sex - 1) + as.factor(hatlev1d), eulfs1998, weights = NULL, method = "quantile", quantile = 0.25, kernel = "gaussian")
rifr_2013 <- dineq::rifr(hwusual ~ age + (sex - 1) + as.factor(hatlev1d), eulfs2013, weights = NULL, method = "quantile", quantile = 0.25, kernel = "gaussian")
```

```{r}
# Function for first-quartile characteristics
q1_fun <- function(df){
  q1_carac <- c(quantile(df$age, probs =0.25), quantile(df$sex - 1, probs =0.25))
  q1_hat <- quantile(eulfs1998$hatlev1d, probs =0.25, na.rm =TRUE)
  for (educ in 1:3){
    q1_educ <- ifelse(q1_hat == educ, 1, 0)
    q1_carac <- c(q1_carac, q1_educ)
  }
  rm(q1_educ)
  q1_carac
}
```

```{r}
# First-quartile characteristics in 1998
q1_1998 <- q1_fun(eulfs1998)
q1_2013 <- q1_fun(eulfs2013)

# Number of hours usually worked as estimated with rif
y1998 <- sum(rifr_1998[["Coef"]]*q1_1998)
y2013 <- sum(rifr_2013[["Coef"]]*q1_2013)

# Decomposition with both effects (explained and unexplained)
ex_effect <- sum((q1_1998 - q1_2013) * rifr_2013[["Coef"]])
unex_effect <- sum(q1_1998 * (rifr_2013[["Coef"]] - rifr_1998[["Coef"]]))
cat("The discrepancy between both years is", format(round(y2013-y1998, 4), nsmall = 4), ", including the explained effect", format(round(ex_effect, 4), nsmall = 4), "and the unexplained effect", format(round(unex_effect, 4), nsmall = 4), ".")

```

The problem is that we have a lots of null values with indicator variables.
This decomposition is thus not very satisfactory.

